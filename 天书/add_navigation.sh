#!/bin/bash

# å¤©ä¹¦é¡¹ç›®å¯¼èˆªé“¾æ¥æ·»åŠ è„šæœ¬

# å®šä¹‰æ‰€æœ‰ç¯‡ç« ï¼ˆæŒ‰é¡ºåºï¼‰
declare -a stories=(
    "å€¾æ–œçš„æ°¸æ’.md"
    "å€¾æ–œ90åº¦çš„æ–‡å­—.md"
    "ç´¢è²äºšæ—¥è®°.md"
    "å¡çŠå¾·æ‹‰çš„æ²‰é»˜è€….md"
    "è®°å¿†çš„å›¾ä¹¦é¦†.md"
    "ç¬¬42å¹´.md"
    "å¦ä¸€ä¸ªå¯»æ‰¾è€….md"
    "å¤©ä¹¦çš„èµå“.md"
    "åšå°”èµ«æ–¯çš„å™©æ¢¦.md"
    "ä¿¡æ¯ä¸ºé›¶çš„å›¾ä¹¦é¦†.md"
    "åœ°å¹³çº¿å®ˆæœ›è€….md"
    "æ—¶é—´çš„å°½å¤´.md"
    "çˆ±çš„å°½å¤´.md"
    "æ²‰é»˜çš„è¯­è¨€.md"
    "æ¢¦è§å¤©ä¹¦.md"
    "å¤©ä¹¦çš„ç‰ˆæœ¬å­¦.md"
    "è¯»è€…æŒ‡å—.md"
    "å¤©ä¹¦å¯»æ‰¾è€…åä¼š.md"
    "æ—¶é—´çš„å¼€ç«¯ï¼Œæˆ–è€…å°½å¤´.md"
    "åè®°æˆ–è€…å‰è¨€.md"
)

# ç¯‡ç« æ ‡é¢˜ï¼ˆç”¨äºå¯¼èˆªæ˜¾ç¤ºï¼‰
declare -a titles=(
    "ç¬¬1ç¯‡ å€¾æ–œçš„æ°¸æ’"
    "ç¬¬2ç¯‡ å€¾æ–œ90åº¦çš„æ–‡å­—"
    "ç¬¬3ç¯‡ ç´¢è²äºšæ—¥è®°"
    "ç¬¬4ç¯‡ å¡çŠå¾·æ‹‰çš„æ²‰é»˜è€…"
    "ç¬¬5ç¯‡ è®°å¿†çš„å›¾ä¹¦é¦†"
    "ç¬¬6ç¯‡ ç¬¬42å¹´"
    "ç¬¬7ç¯‡ å¦ä¸€ä¸ªå¯»æ‰¾è€…"
    "ç¬¬8ç¯‡ å¤©ä¹¦çš„èµå“"
    "ç¬¬9ç¯‡ åšå°”èµ«æ–¯çš„å™©æ¢¦"
    "ç¬¬10ç¯‡ ä¿¡æ¯ä¸ºé›¶çš„å›¾ä¹¦é¦†"
    "ç¬¬11ç¯‡ åœ°å¹³çº¿å®ˆæœ›è€…"
    "ç¬¬12ç¯‡ æ—¶é—´çš„å°½å¤´"
    "ç¬¬13ç¯‡ çˆ±çš„å°½å¤´"
    "ç¬¬14ç¯‡ æ²‰é»˜çš„è¯­è¨€"
    "ç¬¬15ç¯‡ æ¢¦è§å¤©ä¹¦"
    "ç¬¬16ç¯‡ å¤©ä¹¦çš„ç‰ˆæœ¬å­¦"
    "ç¬¬17ç¯‡ è¯»è€…æŒ‡å—"
    "ç¬¬18ç¯‡ å¤©ä¹¦å¯»æ‰¾è€…åä¼š"
    "ç¬¬19ç¯‡ æ—¶é—´çš„å¼€ç«¯ï¼Œæˆ–è€…å°½å¤´"
    "ç¬¬20ç¯‡ åè®°ï¼šæˆ–è€…å‰è¨€"
)

# è·å–æ•°ç»„é•¿åº¦
total=${#stories[@]}

# éå†æ¯ä¸€ç¯‡
for i in "${!stories[@]}"; do
    file="${stories[$i]}"
    filepath="/Users/zouguojun/Library/Mobile Documents/27N4MQEA55~pro~writer/Documents/å¤©ä¹¦/$file"

    echo "å¤„ç†ï¼š$file"

    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$filepath" ]; then
        echo "  âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        continue
    fi

    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    tmpfile="${filepath}.tmp"

    # è®¡ç®—ä¸Šä¸€ç¯‡å’Œä¸‹ä¸€ç¯‡çš„ç´¢å¼•
    prev_idx=$((i - 1))
    next_idx=$((i + 1))

    # æ„å»ºé¡¶éƒ¨å¯¼èˆªï¼ˆè¿”å›ç›®å½•ï¼‰
    top_nav="[âŒ‚ ç›®å½•](./ç›®å½•.md)\n\n---\n\n"

    # æ„å»ºåº•éƒ¨å¯¼èˆª
    bottom_nav="\n\n---\n\n<div align=\"center\">\n\n"

    # ä¸Šä¸€ç¯‡é“¾æ¥ï¼ˆç¬¬1ç¯‡æ²¡æœ‰ä¸Šä¸€ç¯‡ï¼Œå¾ªç¯åˆ°ç¬¬20ç¯‡ï¼‰
    if [ $i -eq 0 ]; then
        # ç¬¬1ç¯‡ï¼šä¸Šä¸€ç¯‡æŒ‡å‘ç¬¬20ç¯‡ï¼ˆå¾ªç¯ï¼‰
        prev_file="${stories[19]}"
        prev_title="${titles[19]}"
        bottom_nav+="[â† ${prev_title}](./${prev_file})"
    else
        prev_file="${stories[$prev_idx]}"
        prev_title="${titles[$prev_idx]}"
        bottom_nav+="[â† ${prev_title}](./${prev_file})"
    fi

    bottom_nav+=" | "
    bottom_nav+="[âŒ‚ ç›®å½•](./ç›®å½•.md)"
    bottom_nav+=" | "

    # ä¸‹ä¸€ç¯‡é“¾æ¥ï¼ˆç¬¬20ç¯‡çš„ä¸‹ä¸€ç¯‡æ˜¯ç¬¬1ç¯‡ï¼Œå¾ªç¯ï¼‰
    if [ $i -eq $((total - 1)) ]; then
        # ç¬¬20ç¯‡ï¼šä¸‹ä¸€ç¯‡æŒ‡å‘ç¬¬1ç¯‡ï¼ˆå¾ªç¯ï¼‰
        next_file="${stories[0]}"
        next_title="${titles[0]}"
        bottom_nav+="[${next_title} â†’](./${next_file})"
    else
        next_file="${stories[$next_idx]}"
        next_title="${titles[$next_idx]}"
        bottom_nav+="[${next_title} â†’](./${next_file})"
    fi

    bottom_nav+="\n\n</div>"

    # è¯»å–åŸæ–‡ä»¶å†…å®¹
    content=$(cat "$filepath")

    # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¯¼èˆªï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
    if echo "$content" | grep -q "âŒ‚ ç›®å½•"; then
        echo "  â„¹ï¸  å·²æœ‰å¯¼èˆªé“¾æ¥ï¼Œè·³è¿‡"
        continue
    fi

    # å†™å…¥æ–°æ–‡ä»¶ï¼šé¡¶éƒ¨å¯¼èˆª + åŸå†…å®¹ + åº•éƒ¨å¯¼èˆª
    echo -e "${top_nav}${content}${bottom_nav}" > "$tmpfile"

    # æ›¿æ¢åŸæ–‡ä»¶
    mv "$tmpfile" "$filepath"

    echo "  âœ“ å®Œæˆ"
done

echo ""
echo "ğŸ‰ å…¨éƒ¨å®Œæˆï¼å·²ä¸º ${total} ç¯‡æ·»åŠ å¯¼èˆªé“¾æ¥ã€‚"
